#!/usr/bin/env bash
# ii-niri setup - Simplified installer
# Commands: install, update, doctor (or TUI if no args)

set -e
cd "$(dirname "$0")"
REPO_ROOT="$(pwd)"

# Load core libraries
source ./sdata/lib/environment-variables.sh
source ./sdata/lib/functions.sh
source ./sdata/lib/package-installers.sh
source ./sdata/lib/dist-determine.sh
source ./sdata/lib/conflicts.sh
source ./sdata/lib/migrations.sh
source ./sdata/lib/versioning.sh
source ./sdata/lib/robust-update.sh
source ./sdata/lib/doctor.sh

prevent_sudo_or_root

trap 'rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null' EXIT INT TERM

# Defaults
ask=true
quiet=false

###############################################################################
# Help
###############################################################################
show_help() {
    cat << 'EOF'
ii-niri setup

Usage: ./setup [command] [options]

Commands:
  (none)     Interactive menu
  install    Full installation (deps + config + files)
  update     Update QML code and restart shell
  doctor     Diagnose and fix problems

Options:
  -y, --yes     Skip prompts (auto-yes)
  -q, --quiet   Minimal output
  -h, --help    Show this help

Examples:
  ./setup              # Interactive menu
  ./setup install -y   # Non-interactive install
  ./setup update       # Update and restart shell
  ./setup doctor       # Fix common issues
EOF
}

###############################################################################
# TUI
###############################################################################
tui_menu() {
    clear
    echo -e "${STY_CYAN}${STY_BOLD}"
    cat << 'BANNER'
╔══════════════════════════════════════════╗
║       ii-niri Setup & Management         ║
╚══════════════════════════════════════════╝
BANNER
    echo -e "${STY_RST}"
    
    # Detect current state
    local is_installed=false
    [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]] && is_installed=true
    
    if $is_installed; then
        local installed_ver=$(get_installed_version)
        local repo_ver=$(get_repo_version)
        echo -e "  Installed: ${STY_GREEN}${installed_ver}${STY_RST}"
        echo -e "  Available: ${STY_CYAN}${repo_ver}${STY_RST}"
        echo ""
    fi
    
    # Menu
    if command -v gum &>/dev/null; then
        local choice
        if $is_installed; then
            choice=$(gum choose --header "What would you like to do?" \
                "Update" "Doctor" "Reinstall" "Help" "Exit")
        else
            choice=$(gum choose --header "What would you like to do?" \
                "Install" "Help" "Exit")
        fi
    else
        echo "Select an option:"
        if $is_installed; then
            select choice in "Update" "Doctor" "Reinstall" "Help" "Exit"; do break; done
        else
            select choice in "Install" "Help" "Exit"; do break; done
        fi
    fi
    
    case "$choice" in
        Install|Reinstall) run_install ;;
        Update) run_update ;;
        Doctor) run_doctor ;;
        Help) show_help; exit 0 ;;
        *) exit 0 ;;
    esac
}

###############################################################################
# Install
###############################################################################
run_install() {
    detect_distro
    
    # Greeting & system info
    source ./sdata/subcmd-install/0.greeting.sh
    
    # Check conflicts
    check_conflicts
    
    # 1. Dependencies
    if [[ "${SKIP_DEPS}" != "true" ]]; then
        source ./sdata/subcmd-install/1.deps-router.sh
    fi
    
    # 2. System setup (groups, services)
    if [[ "${SKIP_SETUPS}" != "true" ]]; then
        source ./sdata/subcmd-install/2.setups.sh
    fi
    
    # 3. Config files
    if [[ "${SKIP_FILES}" != "true" ]]; then
        source ./sdata/subcmd-install/3.files.sh
    fi
    
    # Set version tracking
    set_installed_version "$(get_repo_version)" "$(get_repo_commit)" "setup"
}

###############################################################################
# Update
###############################################################################
run_update() {
    detect_distro
    
    # Check versions
    local installed_ver=$(get_installed_version)
    local installed_commit=$(get_installed_commit)
    local repo_ver=$(get_repo_version)
    local repo_commit=$(get_repo_commit)
    
    # Detect existing install without version tracking
    if [[ "$installed_ver" == "0.0.0" ]] && [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]]; then
        log_info "Detected existing installation without version tracking"
        log_info "Creating version tracking files..."
    elif [[ "$installed_ver" == "$repo_ver" && "$installed_commit" == "$repo_commit" ]]; then
        echo -e "${STY_GREEN}✓ Already up to date${STY_RST} ($installed_ver)"
        
        # Check pending migrations
        local pending=$(count_pending_migrations)
        if [[ "$pending" -gt 0 ]]; then
            echo -e "${STY_YELLOW}$pending pending migration(s) available${STY_RST}"
            if $ask; then
                read -p "Apply migrations now? [Y/n] " -n 1 -r
                echo
                [[ ! $REPLY =~ ^[Nn]$ ]] && run_migrations_interactive
            fi
        fi
        return 0
    fi
    
    echo -e "${STY_CYAN}Updating ii-niri${STY_RST}"
    echo -e "  From: $installed_ver → $repo_ver"
    echo ""
    
    $ask && pause
    
    # Sync QML code only
    export IS_UPDATE=true
    export SKIP_MIGRATIONS=true
    export quiet=true
    
    II_SOURCE="${REPO_ROOT}"
    II_TARGET="${XDG_CONFIG_HOME}/quickshell/ii"
    
    # Backup before update
    log_info "Creating backup..."
    create_update_backup "$II_TARGET" >/dev/null
    
    # Generate manifest
    generate_manifest "$II_SOURCE" "${II_TARGET}/.ii-manifest.new"
    
    # Sync root QML files
    for qml in "${II_SOURCE}"/*.qml; do
        [[ -f "$qml" ]] && cp -f "$qml" "${II_TARGET}/$(basename "$qml")"
    done
    
    # Sync directories
    for dir in modules services scripts assets translations; do
        [[ -d "${II_SOURCE}/${dir}" ]] && rsync -a --delete "${II_SOURCE}/${dir}/" "${II_TARGET}/${dir}/"
    done
    
    # Sync requirements.txt
    [[ -f "${II_SOURCE}/requirements.txt" ]] && cp -f "${II_SOURCE}/requirements.txt" "${II_TARGET}/"
    
    # Finalize manifest and cleanup orphans
    mv "${II_TARGET}/.ii-manifest.new" "${II_TARGET}/.ii-manifest"
    cleanup_orphans "$II_TARGET" "${II_TARGET}/.ii-manifest"
    
    # Fix permissions
    find "$II_TARGET/scripts" \( -name "*.sh" -o -name "*.fish" -o -name "*.py" \) -exec chmod +x {} \; 2>/dev/null || true
    
    # Update version
    set_installed_version "$repo_ver" "$repo_commit" "update"
    
    # Cleanup old backups
    cleanup_old_backups "$II_BACKUP_DIR" 5
    
    echo -e "${STY_GREEN}✓ Update complete${STY_RST}"
    
    # Migrations
    local pending=$(count_pending_migrations)
    if [[ "$pending" -gt 0 ]]; then
        echo ""
        echo -e "${STY_YELLOW}$pending optional migration(s) available${STY_RST}"
        if $ask; then
            read -p "Review and apply? [Y/n] " -n 1 -r
            echo
            [[ ! $REPLY =~ ^[Nn]$ ]] && run_migrations_interactive
        fi
    fi
    
    # Restart shell
    echo ""
    log_info "Restarting shell..."
    qs kill -c ii 2>/dev/null || true
    sleep 1
    nohup qs -c ii >/dev/null 2>&1 &
    disown
    echo -e "${STY_GREEN}✓ Shell restarted${STY_RST}"
}

###############################################################################
# Doctor (delegates to doctor.sh but with fixes)
###############################################################################
run_doctor() {
    run_doctor_with_fixes
}

###############################################################################
# Parse args
###############################################################################
COMMAND=""
while [[ $# -gt 0 ]]; do
    case $1 in
        install) COMMAND="install"; shift ;;
        update) COMMAND="update"; shift ;;
        doctor) COMMAND="doctor"; shift ;;
        -y|--yes) ask=false; shift ;;
        -q|--quiet) quiet=true; shift ;;
        -h|--help) show_help; exit 0 ;;
        *) echo "Unknown: $1"; show_help; exit 1 ;;
    esac
done

###############################################################################
# Run
###############################################################################
case "$COMMAND" in
    install) run_install ;;
    update) run_update ;;
    doctor) run_doctor ;;
    "") tui_menu ;;
esac
